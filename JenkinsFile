pipeline {
    agent any

    environment {
        DIFIDO_URL = 'http://loclalhost:8090'
        BUILD_NUMBER = "${env.BUILD_NUMBER}"
        BUILD_USER = "${env.BUILD_USER}"
        VERSION = '1.0'
        LEGACY = 'false'
        NODE_NAME = "${env.NODE_NAME}"
        SUITE = 'core/tests'  // default suite, can override
    }

    parameters {
        string(name: 'MANUAL_SUITE_NAME', defaultValue: '', description: 'Optional manual suite name')
        string(name: 'TEST_NAME', defaultValue: '', description: 'Optional test name')
    }

    stages {

        stage('Prepare Suite') {
            steps {
                script {
                    if (params.MANUAL_SUITE_NAME) {
                        env.SUITE = params.MANUAL_SUITE_NAME
                    }
                    if (params.TEST_NAME && env.SUITE.startsWith('core/')) {
                        env.SUITE = "${env.SUITE}-${params.TEST_NAME}"
                    }
                    echo "Suite: ${env.SUITE}"
                }
            }
        }

        stage('Create Difido Execution') {
            steps {
                script {
                    env.EXECUTION_ID = sh(script: """curl --silent --data '{
                        "description":"#${BUILD_NUMBER}-${SUITE}-DEV",
                        "executionProperties":{
                            "User":"${BUILD_USER}",
                            "Version":"${VERSION}",
                            "Legacy":"${LEGACY}",
                            "Node":"${NODE_NAME}"
                        },
                        "shared":true,
                        "forceNew":true
                    }' -H "Content-Type:application/json" ${DIFIDO_URL}/api/executions/""", returnStdout: true).trim()
                    echo "Difido Execution ID: ${env.EXECUTION_ID}"
                }
            }
        }

        stage('Run Tests') {
            steps {

               bat 'mvn clean test'.
            }
        }

        stage('Publish to Difido') {
            steps {
                echo "You can upload results to Difido using EXECUTION_ID"
                // Example: sh 'curl -X POST ... -F "executionId=${EXECUTION_ID}" ...'
            }
        }

    }

    post {
        always {
            echo "Pipeline finished"
        }
        success {
            echo "Tests succeeded"
        }
        failure {
            echo "Tests failed"
        }
    }
}
