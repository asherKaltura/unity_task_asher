stage('Prepare Difido Properties') {
    steps {
        script {
            echo 'Preparing Difido configuration file...'

            def executionId = ''
            if (!env.DIFIDO_EXECUTION_ID || env.DIFIDO_EXECUTION_ID == '-1') {
                echo "Creating new Difido execution..."

                // שמור את הפלט של curl לקובץ זמני בתיקייה הראשית
                bat """
                    curl -X POST -H "Content-Type: application/json" ^
                    -d "{\\"description\\":\\"#${env.BUILD_NUMBER}-${env.ENV}\\", \\"executionProperties\\":{\\"User\\":\\"${env.BUILD_USER}\\", \\"Version\\":\\"${env.VERSION}\\", \\"Legacy\\":\\"${env.LEGACY}\\", \\"Node\\":\\"${env.NODE_NAME}\\"}, \\"shared\\":true, \\"forceNew\\":true}" ^
                    ${env.DIFIDO_URL}/api/executions/ > execution_id.txt
                """

                // קרא את ה־execution id מתוך הקובץ
                executionId = readFile('execution_id.txt').trim()
                echo "Got execution id: ${executionId}"
            } else {
                executionId = env.DIFIDO_EXECUTION_ID
            }

            env.EXECUTION_ID = executionId

            // צור את קובץ ההגדרות ישירות בתיקיית העבודה
            bat """
                echo dont.compress.extensions=zip > remoteDifido.properties
                echo port=${env.DIFIDO_PORT} >> remoteDifido.properties
                echo compress.files.above=5000 >> remoteDifido.properties
                echo append.to.existing.execution=true >> remoteDifido.properties
                echo existing.execution.id=${executionId} >> remoteDifido.properties
                echo force.new.execution=false >> remoteDifido.properties
                echo enabled=true >> remoteDifido.properties
                echo execution.properties=User=${env.BUILD_USER};Version=${env.VERSION} >> remoteDifido.properties
                echo host=${env.DIFIDO_HOST} >> remoteDifido.properties
                echo use.shared.execution=true >> remoteDifido.properties
            """

            echo 'remoteDifido.properties created successfully in workspace.'
        }
    }
}
